- [ ] напомнить о пандоре 

- [ ] описать тесты с lozon_id
	- [ ] internal/service/route_sheet_sender/service.go:1044 дернуть, отправить на сборку и глянуть что будет
	- [ ] создаем ml где постинг уже в мл и в создан отправлен в ТАРС
	- [ ] прогнать тесты




? как тестить кафку и outbox?


- раскатил ТС
- разобрался с proxy отправил на ревью (наканец та)
- отправил мр с кешом Мише
- добавил фича флаг, надо ли его добавлять полностью? нет по вэха
- добил тесты по лозон ид + начал смотреть и фиксить + прогнал авто тесты




{
  "courierId": "271715",
  "labels": {
    "additionalProp1": "string",
    "additionalProp2": "string",
    "additionalProp3": "string"
  },
  "ozonId": "string",
  "points": [
    {
      "id": "189885623",
      "plannedDeliveryTime": "2025-09-20T09:52:02.223Z",
      "postingNumber": "0474681206-0052-1",
      "sequence": 0
    }
  ],
  "warehouseLozonId": "21234202382000",
  "warehouseRezonId": "string"
}

---
## Задача: 

- Слушаем топик address-storage-api-boxes
    - **Запросить права на чтение**
    - Утащить конфиг из kafka-reader на размер батча (preferred batch size)
    - Необходим только BoxCreatedEvent, остальные скипаем
- Определяем склад fresh/не fresh по PlaceId
    - Делаем запрос в warehouse-service / place-api с кешом в Redis (ручку докину попозже)
    - Стащить пример из kafka-reader
    - **Запросить права на ручку**
- Определяем, является ли ячейка кликовой
    - На самой ячейке нет тега клика, нужно получить родительскую зону
    - Идем в address-storage-api
        - Дергаем GetCellsRelatives с WithParents
            - за примером в elo-courier-app-api, метод GetShortCellsName
        - Ищем рекурсивно родителя с Type == Zone ?
        - Дергаем GetCellsTags с переданной родительской ячейкой (зоной)
        - Определяем кликовость ячейки по наличию тега "ClickDeliveryWarehouseZone", "ClickDeliveryDS"
        - Альтернативно дергаем GetCellsByPlaceId (наверняка тяжелая ручка), но можно закешировать сразу все ячейки со склада
        - Возможно стоит сходить к ребятам в lms-lspasi-pub и спросить как будет оптимальнее
        - Обязательно кешируем ячейки
        - **Не забыть про права s2s на ручки**
- Если ячейка кликовая, то идем в kafka-reader по clearingID постинга за его posting_number
    - Если не кликовая то выходим
- Продюсим сообщение в топик fresh-address-storage-api-boxes
    - Добавить в контракт proto Timestamp время сообщения (ActionDatetimeUtc 2025-09-04T18:51:06.8166659+00:00)
    - Добавить warehouse_clearing_id (PlaceId) в контракт proto
    - **Добавить схему в базу для аутбокса**

Пример сообщения из топика address-storage-api-boxes
```json
{
  "Id": "56468765e05a4b4e990f3ef50e832b91",
  "Type": "Ozon.Nhl.AddressStorage.Api.Contracts.Kafka.Boxes.BoxCreatedEvent",
  "Value": "{\"BoxId\":\"100000760062000\",\"BoxSource\":1,\"PlaceId\":23843917228000,\"CellId\":917925,\"Operation\":0,\"OperationId\":null,\"OperationContext\":null,\"UserId\":\"ls-qa-bee-zone\",\"UserSource\":2,\"ActionDatetimeUtc\":\"2025-09-04T18:51:06.8166659+00:00\",\"BoxOperation\":{\"Type\":1,\"Source\":\"ls-qa-bee-zone\",\"Timestamp\":null,\"Audit\":{}},\"InnerBoxes\":[],\"CorrelationId\":\"8602de0b-0fc3-41ec-aeed-911c0f4ca027\"}"
}
```

## Блокеры:

- Блокеров нет
- Дизайн не нужен

## Техническая реализация:

- Описание технической реализации

## Критерии приемки:

- Как понимаем что задача выполнена

## Как тестировать:

- Пишем как тестировать

## Что было сделано:

- Пишет разработчки что сделал по задаче, а что не сделал и причины